{% include 'header.html' %}
    <div class="container-fluid">
        <table class="table table-striped table-hover" style="cursor: pointer;" id="loler-table">
            <thead>
                <tr>
                    <th>Client Name</th>
                    <th>Report Date</th>
                    <th>Next Inspection Date</th>
                    <th>Filename</th>
                    <th>Report Count</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for inspection in loler_inspections %}
                <tr>
                    <td>{{ inspection.client_name }}</td>
                    <td>{{ inspection.report_date }}</td>
                    <td>{{ inspection.next_inspection_date }}</td>
                    <td>{{ inspection.file_name }}</td>
                    <td>{{ inspection.report_count }}</td>
                    <td>
                        <a href="/download_file/{{ OUTPUT_FOLDER }}/{{ inspection.file_name }}" class="btn btn-primary btn-sm">Download</a>
                        <button type="button" class="btn btn-danger btn-sm delete-record-button" data-id="{{ inspection.id }}">Delete Record</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <th>
                        <button type="button" data-bs-toggle="modal" data-bs-target="#process-report" class="btn btn-primary">Process Report</button>
                    </th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Modals -->

  <div class="modal fade" id="process-report" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
              <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalToggleLabel">Process LOLER Reports</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                      <div class="input-group mb-3">
                          <div class="btn-group" role="group" aria-label="Basic mixed styles example" style="width:100%;">
                            <button type="file" class="btn btn-secondary" id="resumable_input" style="width:60%;" multiple required>Browse Files:</button>
                            <button type="button" class="btn btn-secondary" id="file-count-display" disabled>No files selected</button>
                          </div>
                      </div>
                      <div class="form-floating mb-3">
                          <input class="form-control" type="text" id="client_name" name="client_name" required>
                          <label for="client_name" class="form-label">Client Name:</label>
                      </div>
                      <button type="button" id="start-upload" class="btn btn-primary" style="width:100%;">Process</button>
              </div>
              <div class="modal-footer">
              </div>
          </div>
      </div>
  </div>
</body>
<script type="text/javascript">
$(document).ready(function () {
    $('#loler-table').DataTable({
        searching: true,
        paging: true
    });

    var r = new Resumable({
        target: '/upload_chunk',
        query: {upload_token: 'unique_upload_token'}, // Adjust as needed
        fileType: ['pdf'],
        maxFileSize: 500*1024*1024, // Adjust according to your needs
        chunkSize: 250*1024*1024, // Adjust chunk size, if necessary
        testChunks: false,
        throttleProgressCallbacks: 1,
    });

    r.assignBrowse(document.getElementById('resumable_input'));

    r.on('fileAdded', function(file, event) {
        var fileCount = r.files.length;
        $('#file-count-display').text(fileCount + " file(s) selected");
    });

    $('#start-upload').click(function(){
        var clientName = $('#client_name').val(); // Capture client name when the process starts
        if(clientName) {
            // Show "Please wait" message
            Swal.fire({
                title: 'Please wait...',
                html: 'Uploading files...',
                allowOutsideClick: false,
                onBeforeOpen: () => {
                    Swal.showLoading();
                }
            });

            r.opts.query.client_name = clientName; // Include client name in query
            r.upload();
        } else {
            alert('Client name is required.');
        }
    });

    // Function to handle file upload completion
    r.on('complete', function(){
        // All files have been uploaded
        console.log("All files have been uploaded successfully.");
        var clientName = $('#client_name').val();
        
        // Close the loading message
        Swal.close();

        // Call startProcessing function after all files are uploaded
        startProcessing(clientName); 
    });

    function startProcessing(clientName) {
            // Show "Please wait" message
            Swal.fire({
                title: 'Please wait...',
                html: 'Processing...',
                allowOutsideClick: false,
                onBeforeOpen: () => {
                    Swal.showLoading();
                }
            });

            $.ajax({
                url: '/start_processing',
                type: 'POST',
                data: JSON.stringify({ 'client_name': clientName }),
                contentType: 'application/json;charset=UTF-8',
                success: function(response) {
                    if(response.status === 'success') {
                        // Close the loading message
                        Swal.close();
                        // Show success message
                        Swal.fire({
                            icon: 'success',
                            title: 'Processing started successfully!',
                            showConfirmButton: false,
                            timer: 1500
                        });
                        
                        // Redirect to the download URL
                        window.location.href = response.download_url;
                        // Delay the page reload
                        setTimeout(function() {
                            // Reload the page to update the view with the new database entry
                            window.location.reload(true);
                        }, 1000); // Adjust the delay as needed, 1000ms = 1 second
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Processing error:", error);
                    // Close the loading message
                    Swal.close();
                    // Show error message
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'An error occurred while processing.'
                    });
                }
            });
        }

    $('.delete-record-button').click(function () {
        var id = $(this).data('id'); // Get the id value from the data-id attribute
        if (confirm('Are you sure you want to delete this record?')) {
            $.ajax({
                type: 'POST',
                url: '/delete-record-loler',
                data: { id: id },
                success: function (response) {
                    console.log('Record deleted successfully:', response);
                    location.reload(true); // Reload the page to update the table
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.error('Error deleting asset:', xhr);
                }
            });
        }
    });    
});

  function toggleTheme() {
    var currentTheme = document.documentElement.getAttribute('data-bs-theme');
    var newTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-bs-theme', newTheme);
    localStorage.setItem('theme', newTheme); // Save theme preference
  }

  // Event listener for the toggle button
  document.getElementById('btnSwitch').addEventListener('click', toggleTheme);

  // Apply saved theme on page load
  document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      document.documentElement.setAttribute('data-bs-theme', savedTheme);
    }
  });
</script>

</html>